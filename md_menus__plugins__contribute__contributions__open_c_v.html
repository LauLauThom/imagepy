<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ImagePy: opencv-plgs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ImagePy
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_menus__plugins__contribute__contributions__open_c_v.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">opencv-plgs </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Path:</b> <a href="https://github.com/Image-Py/opencv-plgs">https://github.com/Image-Py/opencv-plgs</a></p>
<p><b>Version:</b> 0.1</p>
<p><b>Author:</b> YXDragon</p>
<p><b>Email:</b> <a href="#" onclick="location.href='mai'+'lto:'+'yxd'+'ra'+'gon'+'@i'+'mag'+'ep'+'y.o'+'rg'; return false;">yxdra<span style="display: none;">.nosp@m.</span>gon@<span style="display: none;">.nosp@m.</span>image<span style="display: none;">.nosp@m.</span>py.o<span style="display: none;">.nosp@m.</span>rg</a></p>
<p><b>Keyword:</b> opencv</p>
<p><b>Description:</b> OpenCV plugin set for ImagePy</p>
<p>you must fill the information upon, and you can not remove or insert line, you can write free below.</p>
<p>**Introduction:**opencv need not much introductions, It is a famous computer vision library. ImagePy is a interactive image processing framework which can wrap any numpy based library esaily. And supporting multi-channels, imagestack, lookuptable, roi, macros recorder...It is a Plugin system(just like ImageJ but more convenient). This project is a wrapper of opencv for ImagePy plugins!</p>
<p><b>Now It is just a start, I wrap little of opencv's algrism, aimed to introduct how to wrote ImagePy plugin, The Demo in this document is representative.</b></p>
<h2>License </h2>
<p>I know many numpy based project has a BSD license, but, sorry, I use wxpython as ui framework, so, must be under LGPL.</p>
<h2>MainFrame </h2>
<img src="http://opencvplgs.imagepy.org/mainframe.png" alt="mainframe" class="inline"/>
<p>It is ImagePy's MainFrame, like ImageJ. And ImagePy has contains many common function, such as open image, save image, do some filter, do a roi, draw with pencil... It requires wxpython as ui, Numpy as base structure, shapely to treat the roi, and scipy.ndimage to so dome common filter. But this project devotes to <b>do a wrapper for opencv</b>.</p>
<h2>Do a simple filter </h2>
<img src="http://opencvplgs.imagepy.org/laplacian.png" alt="simplefilter" class="inline"/>
 <div class="fragment"><div class="line"># -*- coding: utf-8 -*</div><div class="line">import cv2</div><div class="line">from imagepy.core.engine import Filter</div><div class="line"></div><div class="line">class Plugin(Filter):</div><div class="line">    title = &#39;Laplacian&#39;</div><div class="line">    note = [&#39;all&#39;, &#39;auto_msk&#39;, &#39;auto_snap&#39;]</div><div class="line">    </div><div class="line">    def run(self, ips, snap, img, para = None):</div><div class="line">        return cv2.Laplacian(img, -1)</div></div><!-- fragment --> <h3>These gradient operator is simplest filter with no parameter.</h3>
<ol type="1">
<li>class name must be Plugin</li>
<li>title is necessary, be the plugin's id, show in menus.</li>
<li>set the note, which tells ImagePy what to do for you.</li>
<li>overwrite run method return the result</li>
</ol>
<p>Filter is one of engines, means need a image, then do some change on it, It has a run method in such type:</p><ul>
<li><b>ips</b> is the wrapper of image with some other information (lookup table, roi...)</li>
<li><b>snap</b> is a snapshot of the image, if 'auto_snap' in note, ImagePy will copy the image to snap befor run. (for many filter method must be implemented in a buffer)</li>
<li><b>img</b> is the current image you are processing.</li>
<li><b>para</b> is the parameter you got interactive. (there is no here) <h3>note is very important</h3>
</li>
</ul>
<ul>
<li><b>all</b> means this plugin works for all type image.</li>
<li><b>auto_snap</b> means ImagePy do a snapshot befor processing, then you can use Undo.</li>
<li><b>auto_msk</b> means when there is a roi on the image, Plugin will only influnce the pixel in.</li>
<li>more detail information please see <a href="https://github.com/Image-Py/imagepy">ImagePy's README</a>!</li>
</ul>
<img src="http://opencvplgs.imagepy.org/colorfilter.png" alt="colorfilter" class="inline"/>
 You see, we didnot write code to treat the color image, but it works, and We can draw a ROI on the image, only the ROI area be changed! And we can undo the lasted operation. <b>Even if it is a imagestack, ImagePy will ask you if run every slice!!</b></p>
<h2>Filter with parameter </h2>
<img src="http://opencvplgs.imagepy.org/canny.png" alt="canny" class="inline"/>
 <div class="fragment"><div class="line"># -*- coding: utf-8 -*</div><div class="line">import cv2</div><div class="line">from imagepy.core.engine import Filter</div><div class="line"></div><div class="line">class Plugin(Filter):</div><div class="line">    title = &#39;Canny&#39;</div><div class="line">    note = [&#39;all&#39;, &#39;auto_msk&#39;, &#39;auto_snap&#39;, &#39;preview&#39;]</div><div class="line">    para = {&#39;sigma&#39;:2, &#39;low&#39;:10, &#39;high&#39;:20}</div><div class="line">    view = [(float, (0,10), 1,  &#39;sigma&#39;, &#39;sigma&#39;, &#39;pix&#39;),</div><div class="line">            (&#39;slide&#39;,(0,255), 0, &#39;low_threshold&#39;, &#39;low&#39;),</div><div class="line">            (&#39;slide&#39;,(0,255), 0, &#39;high_threshold&#39;, &#39;high&#39;)]</div><div class="line"></div><div class="line">    def run(self, ips, snap, img, para = None):</div><div class="line">        l = int(para[&#39;sigma&#39;]*2.5)*2+1</div><div class="line">        cv2.GaussianBlur(snap, (l, l), para[&#39;sigma&#39;], dst=img)</div><div class="line">        return cv2.Canny(img, para[&#39;low&#39;], para[&#39;high&#39;])</div></div><!-- fragment --><p> Many Filter need some parameter. Just like Canny. We just need do a little more.</p><ol type="1">
<li><b>para</b> is a dict object, which contains the parameter you need.</li>
<li><b>view</b> tell ImagePy how to interact when this plugin run, **(float, (0,10), 1, 'sigma', 'sigma', 'pix')** means it is a float between 0 and 10, title is sigma, corresponding to the sigma parameter with unit pix. More detail information please see <a href="https://github.com/Image-Py/imagepy">ImagePy's README</a>!</li>
</ol>
<p><b>Add 'preview' in note, then when you adjust the parameter, ImagePy run this plugin immediately</b></p>
<img src="http://opencvplgs.imagepy.org/threshold.png" alt="canny" class="inline"/>
 <div class="fragment"><div class="line"># -*- coding: utf-8 -*-</div><div class="line">from imagepy import IPy</div><div class="line">import numpy as np, cv2</div><div class="line">from imagepy.core.engine import Filter</div><div class="line">        </div><div class="line">class Plugin(Filter):</div><div class="line">    title = &#39;Adaptive Threshold&#39;</div><div class="line">    note = [&#39;8-bit&#39;, &#39;auto_msk&#39;, &#39;auto_snap&#39;, &#39;preview&#39;]</div><div class="line">    para = {&#39;max&#39;:255, &#39;med&#39;:&#39;mean&#39;, &#39;size&#39;:9, &#39;offset&#39;:2, &#39;inv&#39;:False}</div><div class="line">    view = [(int, (0, 255), 0, &#39;maxvalue&#39;, &#39;max&#39;, &#39;&#39;),</div><div class="line">            (list, [&#39;mean&#39;, &#39;gauss&#39;], str, &#39;method&#39;, &#39;med&#39;, &#39;&#39;),</div><div class="line">            (int, (3, 31), 0, &#39;blocksize&#39;, &#39;size&#39;, &#39;pix&#39;),</div><div class="line">            (int, (0, 50), 0, &#39;offset&#39;, &#39;offset&#39;, &#39;&#39;),</div><div class="line">            (bool, &#39;binary invert&#39;, &#39;inv&#39;)]</div><div class="line">    </div><div class="line">    #process</div><div class="line">    def run(self, ips, snap, img, para = None):</div><div class="line">        med = cv2.ADAPTIVE_THRESH_MEAN_C if para[&#39;med&#39;]==&#39;mean&#39; else cv2.ADAPTIVE_THRESH_GAUSSIAN_C</div><div class="line">        mtype = cv2.THRESH_BINARY_INV if para[&#39;inv&#39;] else cv2.THRESH_BINARY</div><div class="line">        cv2.adaptiveThreshold(snap, para[&#39;max&#39;], med, para[&#39;inv&#39;], para[&#39;size&#39;], para[&#39;offset&#39;], dst=img)</div></div><!-- fragment --><p> Adaptive Threshold demo shows more data type, (choice, bool)</p>
<p><b>some method has a output parameter dst, just give the img and need not return(That will save memory, In fact ImagePy will copy the return to image, then update view)</b></p>
<h2>Watershed with interactive marker </h2>
<img src="http://opencvplgs.imagepy.org/watershed.png" alt="interactive watershed" class="inline"/>
 <div class="fragment"><div class="line"># -*- coding: utf-8 -*</div><div class="line">from imagepy.core.engine import Filter</div><div class="line">import numpy as np, cv2</div><div class="line"></div><div class="line">class Plugin(Filter):</div><div class="line">    title = &#39;Active Watershed&#39;</div><div class="line">    note = [&#39;rgb&#39;, &#39;req_roi&#39;, &#39;not_slice&#39;, &#39;auto_snap&#39;]</div><div class="line">    </div><div class="line">    def run(self, ips, snap, img, para = None):</div><div class="line">        a, msk = cv2.connectedComponents(ips.get_msk().astype(np.uint8))</div><div class="line">        msk = cv2.watershed(img, msk)==-1</div><div class="line">        img //= 2</div><div class="line">        img[msk] = 255</div></div><!-- fragment --><p> ImagePy support ROI, you can use tool to draw a roi(point, line, polygon...), And We can use ips.roi access it, and ips.get_msk(mode='in') to get the roi mask image. <b>mode can be 'in','out',or int means a sketch with specific width.</b> Then use the mask as marker to do a watershed,</p>
<ol type="1">
<li><b>req_roi</b> means this plugin need a roi, ImagePy will check for you, if ther is not, interrupt the plugin.</li>
<li><b>not_slice</b> tells Imagepy need not to iterate slices if it is a stack, because this interactive is ok for specific image, there is no need to go through.</li>
</ol>
<p><b>we can do watershed and get the result, then we can add some stroke where missed segment. then use Undo, and watershed again, we got a perfect result!</b></p>
<h2>Interactive Grabcut </h2>
<p>this demo use build a Tool, and call a plugin in the tool's event. <img src="http://opencvplgs.imagepy.org/grabcut.png" alt="grabcut" class="inline"/>
<h3>Mark</h3>
<p>mark is a overlay drawn on a image, It has draw method with parameter:</p><ol type="1">
<li><b>dc</b> a wx dc contex.</li>
<li><b>f</b> project from image coordinate to canvas coordinate.</li>
<li><b>key</b> other parameter such as slice number. <div class="fragment"><div class="line"># -*- coding: utf-8 -*</div><div class="line">from imagepy.core.engine import Tool, Filter</div><div class="line">import numpy as np, wx, cv2</div><div class="line"></div><div class="line">class Mark():</div><div class="line">    def __init__(self):</div><div class="line">        self.foreline, self.backline = [], []</div><div class="line"></div><div class="line">    def draw(self, dc, f, **key):</div><div class="line">        dc.SetPen(wx.Pen((255,0,0), width=2, style=wx.SOLID))</div><div class="line">        for line in self.foreline: dc.DrawLines([f(*i) for i in line])</div><div class="line">        dc.SetPen(wx.Pen((0,0,255), width=2, style=wx.SOLID))</div><div class="line">        for line in self.backline: dc.DrawLines([f(*i) for i in line])</div><div class="line"></div><div class="line">    def line(self, img, line, color):</div><div class="line">        x0, y0 = line[0]</div><div class="line">        for x, y in line[1:]:</div><div class="line">            cv2.line(img, (int(x0), int(y0)), (int(x), int(y)), color, 2)</div><div class="line">            x0, y0 = x, y</div><div class="line"></div><div class="line">    def buildmsk(self, shape):</div><div class="line">        img = np.zeros(shape[:2], dtype=np.uint8)</div><div class="line">        img[:] = 3</div><div class="line">        for line in self.foreline: self.line(img, line, 1)</div><div class="line">        for line in self.backline: self.line(img, line, 0)</div><div class="line">        return img</div></div><!-- fragment --></li>
</ol>
<ol type="1">
<li><b>draw</b> we need a foreground list and a background list, then draw in diffrent colors</li>
<li><b>buildmsk</b> in the grabcut we need a method to build a mask.</li>
</ol>
<p>### Grabcut </p><div class="fragment"><div class="line">class GrabCut(Filter):</div><div class="line">    title = &#39;Grab Cut&#39;</div><div class="line">    note = [&#39;rgb&#39;, &#39;not_slice&#39;, &#39;auto_snap&#39;, &#39;not_channel&#39;]</div><div class="line">    </div><div class="line">    def run(self, ips, snap, img, para = None):</div><div class="line">        msk = ips.mark.buildmsk(img.shape)</div><div class="line">        bgdModel = np.zeros((1,65),np.float64)</div><div class="line">        fgdModel = np.zeros((1,65),np.float64)</div><div class="line">        msk, bgdModel, fgdModel = cv2.grabCut(snap, msk,None,bgdModel,fgdModel,5,cv2.GC_INIT_WITH_MASK)</div><div class="line">        img[msk%2 == 0] //= 3</div></div><!-- fragment --><p> this is a Filter do the grabcut method, It get mask from the mark.</p>
<h3>Tool</h3>
<p>Tool is one of ImagePy's engines. you need implements these method:</p><ol type="1">
<li><b>mouse_down</b> when mousedown, youcan got the current imageplus, the x, y. and which button is down, and some other informationg from key,(if ctrl, alt, shift is pressed...)</li>
<li><b>mouse_up</b> like mouse_down</li>
<li><b>mouse_move</b> like mouse_down</li>
<li><b>mouse_wheel</b> like mouse_down</li>
</ol>
<div class="fragment"><div class="line">class Plugin(Tool):</div><div class="line">    title = &#39;Grabcut&#39;</div><div class="line">    &quot;&quot;&quot;FreeLinebuf class plugin with events callbacks&quot;&quot;&quot;</div><div class="line">    def __init__(self):</div><div class="line">        self.status = -1</div><div class="line">            </div><div class="line">    def mouse_down(self, ips, x, y, btn, **key):</div><div class="line">        if not isinstance(ips.mark, Mark):</div><div class="line">            ips.mark = Mark()</div><div class="line">        if btn==1 and not key[&#39;ctrl&#39;]:</div><div class="line">            self.status = 1</div><div class="line">            self.cur = [(x, y)]</div><div class="line">            ips.mark.foreline.append(self.cur)</div><div class="line">        if btn==1 and key[&#39;ctrl&#39;]:</div><div class="line">            del ips.mark.foreline[:]</div><div class="line">            del ips.mark.backline[:]</div><div class="line">        if btn==3 and not key[&#39;ctrl&#39;]:</div><div class="line">            self.status = 0</div><div class="line">            self.cur = [(x, y)]</div><div class="line">            ips.mark.backline.append(self.cur)</div><div class="line">        if btn==3 and key[&#39;ctrl&#39;]:</div><div class="line">            GrabCut().start()</div><div class="line">        ips.update()</div><div class="line">    </div><div class="line">    def mouse_up(self, ips, x, y, btn, **key):</div><div class="line">        if self.status==1 and len(self.cur)==1:</div><div class="line">            ips.mark.foreline.remove(self.cur)</div><div class="line">        if self.status==0 and len(self.cur)==1:</div><div class="line">            ips.mark.backline.remove(self.cur)</div><div class="line">        self.status = -1</div><div class="line">        ips.update()</div><div class="line">    </div><div class="line">    def mouse_move(self, ips, x, y, btn, **key):</div><div class="line">        if self.status!=-1:</div><div class="line">            self.cur.append((x, y))</div><div class="line">            ips.update()</div><div class="line">        </div><div class="line">    def mouse_wheel(self, ips, x, y, d, **key):</div><div class="line">        pass</div></div><!-- fragment --><p> <b>here we do these:</b></p><ol type="1">
<li>put track in foreground list when move whith left button pressed.</li>
<li>put track in background list when move whith right button pressed.</li>
<li>clear foreground and background list if left click with ctrl pressed.</li>
<li>do grabcut when right click with ctrl pressed.</li>
</ol>
<p><b>Tool files are stored in the sub-folder of tools, with a generated 16 * 16 thumbnail icon. The icon and the tool are stored in the same name as the gif file</b></p>
<h2>Surf Demo </h2>
<p>continued from the interactive threshold watershed demo <img src="http://opencvplgs.imagepy.org/surf.png" alt="fragment" class="inline"/>
 this demo use surf feature to match two points and find the homo Matrix.(not in this project but in imagepy&gt;plugin&gt;surf)</p>
<p><b>we can use IPy.write, IPy.table to generate text log and data grid conviniently</b></p>
<h2>Macros </h2>
<img src="http://opencvplgs.imagepy.org/macros.png" alt="record" class="inline"/>
<p><b>Macros</b> is one of engines, It is a text file with every line as: **"PluginID &gt; {parameter}"**, If the parameter is None and the Plugin need parameter, IPy will show dialog to interact, if the parameter is given, ImagePy just run use the given parameter.</p>
<p>We can Open the <b>Plugin &gt; Macros &gt; Macros Recorder</b> to record the operate. Then save as a file with **.mc** extent under the menus folder. It will be parsed as a menu when started next. This is Macros, We never need to implements ourself.</p>
<p>Then we Try the <b>Surf Demo</b> macros, Wow!, It run the command sequence automatically!</p>
<p><b>We can use Macros to do some bat processing, what more? It can be used as a good tutorial, We just implement the baseic method, and use macros to show this method can solve such problem!!!</b></p>
<h2>About the plugin's order </h2>
<img src="http://opencvplgs.imagepy.org/catlog.png" alt="catlog" class="inline"/>
<p>ImagePy is a plugin framework. The Catlog will be parsed as the corresponding menus. You just copy package under the menus folder or it's sub folder. But the question is, Our function will be in a disordered order. <b>So we can add a list called catlog under every init file.</b></p>
<img src="http://opencvplgs.imagepy.org/order.png" alt="plugins" class="inline"/>
<p>Now OpenCV menu is before the Help, and the Threshold is the first Item, then Filter, Segmentation, last is Demo. and if we put '-' in catlog, It will be parsed as a spliter line.</p>
<p><b>OK! That is a start, I want more developer can join. I think it is significative to let Opencv be esaier to approach, Benifit more scientists who does not master programming. But I cannot do it by myself, My English is not so good, and have little spare time, But I will do my best!</b> </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
